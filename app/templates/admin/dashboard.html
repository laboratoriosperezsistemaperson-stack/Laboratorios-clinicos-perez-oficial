{% extends "base_admin.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
    /* Estilos modernos para el dashboard */
    .container-fluid {
        padding: 30px;
    }

    @media (max-width: 576px) {
        .container-fluid {
            padding: 15px !important;
        }
    }

    /* Botones de exportación modernos */
    .export-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .btn-export {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.4);
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-export:hover {
        background: white;
        color: #16A085;
        border-color: white;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .btn-export i {
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .btn-export:hover i {
        transform: scale(1.2);
    }

    .btn-export.pdf {
        background: rgba(231, 76, 60, 0.15);
        border-color: rgba(231, 76, 60, 0.4);
    }

    .btn-export.pdf:hover {
        background: #E74C3C;
        color: white;
        border-color: #E74C3C;
    }

    .btn-export.excel {
        background: rgba(39, 174, 96, 0.15);
        border-color: rgba(39, 174, 96, 0.4);
    }

    .btn-export.excel:hover {
        background: #27AE60;
        color: white;
        border-color: #27AE60;
    }

    /* Tarjetas de estadísticas mejoradas */
    .stat-card-modern {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 3px solid transparent;
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .stat-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(135deg, var(--color), var(--color-dark));
    }

    .stat-card-modern.verde {
        --color: #1ABC9C;
        --color-dark: #16A085;
    }

    .stat-card-modern.naranja {
        --color: #F39C12;
        --color-dark: #E67E22;
    }

    .stat-card-modern.azul {
        --color: #3498DB;
        --color-dark: #2980B9;
    }

    .stat-card-modern.morado {
        --color: #9B59B6;
        --color-dark: #8E44AD;
    }

    .stat-card-modern:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        border-color: var(--color);
    }

    .stat-card-icon {
        width: 70px;
        height: 70px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        background: linear-gradient(135deg, var(--color), var(--color-dark));
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stat-card-icon i {
        font-size: 35px;
        color: white;
    }

    .stat-card-modern h3 {
        font-size: 2.8rem;
        font-weight: 800;
        color: #2C3E50;
        margin: 15px 0;
    }

    .stat-card-modern p {
        color: #7F8C8D;
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 15px;
    }

    .stat-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        background: rgba(26, 188, 156, 0.1);
        color: #16A085;
    }

    /* Tarjetas de gráficos */
    .chart-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        transition: all 0.3s ease;
    }

    .chart-card:hover {
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.12);
    }

    .chart-card h4 {
        font-size: 1.4rem;
        font-weight: 700;
        color: #2C3E50;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chart-card h4 i {
        color: #1ABC9C;
        font-size: 1.6rem;
    }

    /* Botones de acción rápida */
    .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .action-btn {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-decoration: none;
        color: #2C3E50;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        border: 3px solid transparent;
    }

    .action-btn:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 40px rgba(26, 188, 156, 0.2);
        border-color: #1ABC9C;
        color: #1ABC9C;
    }

    .action-btn i {
        font-size: 3rem;
        color: #1ABC9C;
        transition: all 0.3s ease;
    }

    .action-btn:hover i {
        transform: scale(1.15);
    }

    .action-btn span {
        font-weight: 700;
        font-size: 1.05rem;
    }

    /* Tabla de top pruebas */
    .top-pruebas-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .top-pruebas-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: #F8F9FA;
        border-radius: 10px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
    }

    .top-pruebas-list li:hover {
        background: rgba(26, 188, 156, 0.1);
        transform: translateX(10px);
    }

    .prueba-nombre {
        font-weight: 600;
        color: #2C3E50;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .prueba-nombre i {
        color: #1ABC9C;
    }

    .prueba-count {
        background: linear-gradient(135deg, #1ABC9C, #16A085);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.95rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header h1 {
            font-size: 1.8rem;
        }

        .stat-card-modern h3 {
            font-size: 2rem;
        }

        .action-buttons {
            grid-template-columns: 1fr;
        }

        .export-buttons {
            flex-direction: column;
            width: 100%;
        }

        .btn-export {
            width: 100%;
            justify-content: center;
        }

        /* Adjust filter bar stacking */
        .d-flex.align-items-center.gap-3 {
            flex-direction: column;
            align-items: stretch !important;
            width: 100%;
        }

        .d-flex.align-items-center.gap-3>* {
            width: 100%;
            justify-content: center;
        }

        .btn-outline-secondary {
            width: 100%;
        }
    }
</style>

<div class="container-fluid" style="padding: 30px;">
    <!-- Panel de Exportacion Mejorado -->
    <div class="export-panel mb-4"
        style="background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.08);">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
            <div class="w-100 w-md-auto text-center text-md-start">
                <h5 style="margin: 0; color: #2C3E50; font-weight: 700;">
                    <i class="fas fa-download" style="color: #F39C12;"></i> Centro de Exportacion Avanzado
                </h5>
                <small style="color: #6c757d;">Exporte datos completos con formato profesional</small>
            </div>
            <div class="d-flex gap-2 flex-wrap w-100 w-md-auto justify-content-center">
                <button id="btnExportPDF" onclick="ejecutarExportacion('pdf')"
                    class="btn flex-grow-1 flex-md-grow-0 justify-content-center"
                    style="background: linear-gradient(135deg, #E74C3C, #C0392B); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
                <button id="btnExportExcel" onclick="ejecutarExportacion('excel')"
                    class="btn flex-grow-1 flex-md-grow-0 justify-content-center"
                    style="background: linear-gradient(135deg, #27AE60, #229954); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);">
                    <i class="fas fa-file-excel"></i> Exportar Excel
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col-12 col-sm-6 col-md-3 mb-2">
                <label class="export-option"
                    style="display: flex; align-items: center; gap: 10px; padding: 12px 15px; background: rgba(243, 156, 18, 0.1); border-radius: 10px; cursor: pointer; transition: all 0.3s; border: 2px solid #F39C12;">
                    <input type="checkbox" id="exportPacientes" checked
                        style="width: 18px; height: 18px; accent-color: #F39C12;">
                    <i class="fas fa-users" style="color: #F39C12;"></i>
                    <div>
                        <span style="font-weight: 600; color: #2C3E50; display: block;">Pacientes</span>
                        <small style="color: #6c757d;">{{ total_pacientes }} registros</small>
                    </div>
                </label>
            </div>
            <div class="col-12 col-sm-6 col-md-3 mb-2">
                <label class="export-option"
                    style="display: flex; align-items: center; gap: 10px; padding: 12px 15px; background: rgba(243, 156, 18, 0.1); border-radius: 10px; cursor: pointer; transition: all 0.3s; border: 2px solid #F39C12;">
                    <input type="checkbox" id="exportResultados" checked
                        style="width: 18px; height: 18px; accent-color: #F39C12;">
                    <i class="fas fa-file-medical" style="color: #F39C12;"></i>
                    <div>
                        <span style="font-weight: 600; color: #2C3E50; display: block;">Resultados</span>
                        <small style="color: #6c757d;">{{ total_resultados }} registros</small>
                    </div>
                </label>
            </div>
            <div class="col-12 col-sm-6 col-md-3 mb-2">
                <label class="export-option"
                    style="display: flex; align-items: center; gap: 10px; padding: 12px 15px; background: rgba(243, 156, 18, 0.1); border-radius: 10px; cursor: pointer; transition: all 0.3s; border: 2px solid #F39C12;">
                    <input type="checkbox" id="exportPruebas" checked
                        style="width: 18px; height: 18px; accent-color: #F39C12;">
                    <i class="fas fa-vial" style="color: #F39C12;"></i>
                    <div>
                        <span style="font-weight: 600; color: #2C3E50; display: block;">Pruebas</span>
                        <small style="color: #6c757d;">{{ total_pruebas }} disponibles</small>
                    </div>
                </label>
            </div>
            <div class="col-12 col-sm-6 col-md-3 mb-2">
                <label class="export-option"
                    style="display: flex; align-items: center; gap: 10px; padding: 12px 15px; background: rgba(243, 156, 18, 0.1); border-radius: 10px; cursor: pointer; transition: all 0.3s; border: 2px solid #F39C12;">
                    <input type="checkbox" id="exportEstadisticas" checked
                        style="width: 18px; height: 18px; accent-color: #F39C12;">
                    <i class="fas fa-chart-line" style="color: #F39C12;"></i>
                    <div>
                        <span style="font-weight: 600; color: #2C3E50; display: block;">Estadisticas</span>
                        <small style="color: #6c757d;">Graficos y tendencias</small>
                    </div>
                </label>
            </div>
        </div>

        <!-- Filtros Inteligentes de Exportación -->
        <div class="mt-3 p-3"
            style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; border: 1px solid #dee2e6;">
            <div class="d-flex align-items-center gap-2 mb-3">
                <i class="fas fa-magic" style="color: #F39C12;"></i>
                <strong style="color: #2C3E50;">Filtros Inteligentes</strong>
                <small class="text-muted ms-2">— Los filtros se adaptan automáticamente según tu selección</small>
            </div>

            <!-- Barra de estado del filtro -->
            <div id="filterStatusBar" class="mb-3 p-2"
                style="background: rgba(26, 188, 156, 0.1); border-radius: 8px; display: none;">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-info-circle" style="color: #1ABC9C;"></i>
                        <span id="filterStatusText" style="color: #2C3E50; font-weight: 500;">Todos los registros</span>
                    </div>
                    <span id="filterPreviewCount" class="badge ms-auto ms-sm-auto"
                        style="background: linear-gradient(135deg, #1ABC9C, #16A085); color: white; white-space: normal; text-align: right;"></span>
                </div>
            </div>

            <div class="row g-3">
                <!-- Selector de Tipo de Exportación -->
                <div class="col-md-3">
                    <label class="form-label text-muted small mb-1">
                        <i class="fas fa-layer-group me-1"></i>¿Qué desea exportar?
                    </label>
                    <select id="tipoExportacion" class="form-select form-select-sm"
                        style="border-radius: 8px; border: 2px solid #F39C12;">
                        <option value="todo">📦 Todo (Reporte Completo)</option>
                        <option value="paciente">👤 Un Paciente Específico</option>
                        <option value="prueba">🧪 Una Prueba Específica</option>
                        <option value="fecha">📅 Por Rango de Fechas</option>
                    </select>
                </div>

                <!-- Filtro Dinámico de Paciente -->
                <div class="col-md-3" id="filtroContainer">
                    <label class="form-label text-muted small mb-1" id="filtroLabel">
                        <i class="fas fa-user me-1"></i>Seleccionar:
                    </label>
                    <select id="filtroPrincipal" class="form-select form-select-sm" style="border-radius: 8px;">
                        <option value="">-- Seleccione primero el tipo --</option>
                    </select>
                </div>

                <!-- Fechas (visible solo cuando tipo=fecha) -->
                <div class="col-md-3 d-none" id="fechaDesdeContainer">
                    <label class="form-label text-muted small mb-1">
                        <i class="fas fa-calendar me-1"></i>Desde:
                    </label>
                    <input type="date" id="fechaDesde" class="form-control form-control-sm" style="border-radius: 8px;">
                </div>
                <div class="col-md-3 d-none" id="fechaHastaContainer">
                    <label class="form-label text-muted small mb-1">
                        <i class="fas fa-calendar-check me-1"></i>Hasta:
                    </label>
                    <input type="date" id="fechaHasta" class="form-control form-control-sm" style="border-radius: 8px;">
                </div>

                <!-- Vista previa de datos -->
                <div class="col-md-3" id="previewContainer">
                    <label class="form-label text-muted small mb-1">
                        <i class="fas fa-eye me-1"></i>Vista Previa:
                    </label>
                    <div id="previewBox" class="p-2 text-center"
                        style="background: white; border-radius: 8px; border: 1px solid #dee2e6;">
                        <span id="previewText" style="color: #6c757d; font-size: 0.85rem;">Seleccione filtros</span>
                    </div>
                </div>
            </div>

            <!-- Opciones adicionales y Botones de Exportación -->
            <div class="mt-3 pt-3" style="border-top: 1px solid #dee2e6;">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                    <div class="d-flex align-items-center gap-3">
                        <label class="d-flex align-items-center gap-2" style="cursor: pointer;">
                            <input type="checkbox" id="incluirEliminados"
                                style="width: 16px; height: 16px; accent-color: #E74C3C;">
                            <i class="fas fa-trash-restore" style="color: #E74C3C;"></i>
                            <span style="color: #2C3E50; font-weight: 500;">Incluir eliminados</span>
                        </label>

                        <label class="d-flex align-items-center gap-2" style="cursor: pointer;">
                            <input type="checkbox" id="incluirDetalles" checked
                                style="width: 16px; height: 16px; accent-color: #3498DB;">
                            <i class="fas fa-list-alt" style="color: #3498DB;"></i>
                            <span style="color: #2C3E50; font-weight: 500;">Incluir detalles</span>
                        </label>

                        <button type="button" onclick="limpiarFiltrosInteligentes()"
                            class="btn btn-sm btn-outline-secondary" style="border-radius: 8px;">
                            <i class="fas fa-undo me-1"></i>Reiniciar
                        </button>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <span class="text-muted small fw-bold">Exportar:</span>
                        <button type="button" onclick="ejecutarExportacionInteligente('pdf')"
                            class="btn btn-sm btn-danger text-white d-flex align-items-center gap-2"
                            style="border-radius: 8px; font-weight: 600; padding: 8px 16px;">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button type="button" onclick="ejecutarExportacionInteligente('excel')"
                            class="btn btn-sm btn-success text-white d-flex align-items-center gap-2"
                            style="border-radius: 8px; font-weight: 600; padding: 8px 16px;">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de Estadisticas -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card-modern verde">
                <div class="stat-card-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>{{ total_pacientes }}</h3>
                <p>Total Pacientes</p>
                <span class="stat-badge">
                    <i class="fas fa-plus-circle"></i> {{ pacientes_este_mes }} este mes
                </span>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card-modern naranja">
                <div class="stat-card-icon">
                    <i class="fas fa-file-medical"></i>
                </div>
                <h3>{{ total_resultados }}</h3>
                <p>Total Resultados</p>
                <span class="stat-badge">
                    <i class="fas fa-plus-circle"></i> {{ resultados_este_mes }} este mes
                </span>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card-modern azul">
                <div class="stat-card-icon">
                    <i class="fas fa-vial"></i>
                </div>
                <h3>{{ total_pruebas }}</h3>
                <p>Pruebas Disponibles</p>
                <span class="stat-badge">
                    <i class="fas fa-check-circle"></i> Activas
                </span>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card-modern morado">
                <div class="stat-card-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h3>{{ pacientes_este_mes + resultados_este_mes }}</h3>
                <p>Actividad del Mes</p>
                <span class="stat-badge">
                    <i class="fas fa-trending-up"></i> Total
                </span>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="chart-card">
                <h4>
                    <i class="fas fa-chart-area"></i>
                    Tendencia de Pacientes y Resultados
                </h4>
                <canvas id="trendChart" style="max-height: 350px;"></canvas>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="chart-card">
                <h4>
                    <i class="fas fa-flask"></i>
                    Últimas Pruebas
                </h4>
                {% if top_pruebas %}
                <ul class="top-pruebas-list">
                    {% for prueba, precio in top_pruebas %}
                    <li>
                        <span class="prueba-nombre">
                            <i class="fas fa-vial"></i>
                            {{ prueba }}
                        </span>
                        <span class="prueba-count">Bs. {{ "%.2f"|format(precio) }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center py-4">
                    <i class="fas fa-info-circle"></i> No hay pruebas disponibles
                </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Gráfico de Distribución -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <h4>
                    <i class="fas fa-chart-pie"></i>
                    Distribución General
                </h4>
                <canvas id="distributionChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <h4>
                    <i class="fas fa-chart-bar"></i>
                    Comparación Mensual
                </h4>
                <canvas id="comparisonChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="chart-card">
        <h4>
            <i class="fas fa-bolt"></i>
            Acciones Rápidas
        </h4>
        <div class="action-buttons">
            <a href="{{ url_for('main.admin_pacientes') }}" class="action-btn">
                <i class="fas fa-users"></i>
                <span>Gestionar Pacientes</span>
            </a>
            <a href="{{ url_for('main.admin_resultados') }}" class="action-btn">
                <i class="fas fa-file-upload"></i>
                <span>Subir Resultado</span>
            </a>
            <a href="{{ url_for('main.admin_pruebas') }}" class="action-btn">
                <i class="fas fa-flask"></i>
                <span>Gestionar Pruebas</span>
            </a>
            <a href="{{ url_for('main.index') }}" class="action-btn" target="_blank">
                <i class="fas fa-globe"></i>
                <span>Ver Sitio Público</span>
            </a>
        </div>
    </div>
</div>

<!-- Datos del servidor (formato JSON en elemento HTML) -->
<div id="dashboard-data" style="display:none;" data-ultimos-meses='{{ ultimos_meses | tojson | safe }}'
    data-pacientes-data='{{ pacientes_data | tojson | safe }}'
    data-resultados-data='{{ resultados_data | tojson | safe }}' data-total-pacientes='{{ total_pacientes }}'
    data-total-resultados='{{ total_resultados }}' data-total-pruebas='{{ total_pruebas }}'>
</div>

<!-- Datos para exportación (pre-serializado desde Python) -->
<script id="export-data" type="application/json">
{{ export_data_json | safe }}
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Librerías para exportación -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Módulos de exportación -->
<script src="{{ url_for('static', filename='js/admin/export-pacientes.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/export-pruebas.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/export-resultados.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/export-estadisticas.js') }}"></script>

<!-- Lógica del dashboard -->
<script src="{{ url_for('static', filename='js/admin/dashboard.js') }}"></script>

<!-- Script de filtros inteligentes y exportación -->
<script>
    // Datos para filtros inteligentes
    const exportDataRaw = JSON.parse(document.getElementById('export-data')?.textContent || '{}');
    const pacientesData = exportDataRaw.pacientes || [];
    const pruebasData = exportDataRaw.pruebas || [];
    const resultadosData = exportDataRaw.resultados || [];

    // Configuración inicial al cargar
    document.addEventListener('DOMContentLoaded', function () {
        const tipoSelect = document.getElementById('tipoExportacion');
        if (tipoSelect) {
            tipoSelect.addEventListener('change', actualizarFiltrosInteligentes);
            actualizarFiltrosInteligentes(); // Inicializar
        }

        // Escuchar cambios en el filtro principal
        const filtroPrincipal = document.getElementById('filtroPrincipal');
        if (filtroPrincipal) {
            filtroPrincipal.addEventListener('change', actualizarVistaPrevia);
        }

        // Escuchar cambios en fechas
        document.getElementById('fechaDesde')?.addEventListener('change', actualizarVistaPrevia);
        document.getElementById('fechaHasta')?.addEventListener('change', actualizarVistaPrevia);
    });

    // Actualizar filtros según el tipo seleccionado
    function actualizarFiltrosInteligentes() {
        const tipo = document.getElementById('tipoExportacion')?.value || 'todo';
        const filtroContainer = document.getElementById('filtroContainer');
        const filtroPrincipal = document.getElementById('filtroPrincipal');
        const filtroLabel = document.getElementById('filtroLabel');
        const fechaDesdeContainer = document.getElementById('fechaDesdeContainer');
        const fechaHastaContainer = document.getElementById('fechaHastaContainer');
        const filterStatusBar = document.getElementById('filterStatusBar');

        // Reiniciar contenedores de fecha
        fechaDesdeContainer?.classList.add('d-none');
        fechaHastaContainer?.classList.add('d-none');
        filtroContainer?.classList.remove('d-none');

        // Limpiar opciones
        if (filtroPrincipal) filtroPrincipal.innerHTML = '';

        switch (tipo) {
            case 'todo':
                filtroLabel.innerHTML = '<i class="fas fa-check-circle me-1"></i>Exportación:';
                filtroPrincipal.innerHTML = '<option value="completo">✅ Reporte Completo (Todo)</option>';
                filterStatusBar.style.display = 'block';
                document.getElementById('filterStatusText').textContent = 'Exportará todos los datos del sistema';
                document.getElementById('filterPreviewCount').innerHTML =
                    `${pacientesData.length} pacientes <span class="d-none d-sm-inline">•</span> <br class="d-sm-none"> ${resultadosData.length} resultados <span class="d-none d-sm-inline">•</span> <br class="d-sm-none"> ${pruebasData.length} pruebas`;
                break;

            case 'paciente':
                filtroLabel.innerHTML = '<i class="fas fa-user me-1"></i>Seleccionar Paciente:';
                filtroPrincipal.innerHTML = '<option value="">-- Seleccione un paciente --</option>';
                pacientesData.forEach(p => {
                    const resultadosPaciente = resultadosData.filter(r => r.paciente_id == p.id).length;
                    filtroPrincipal.innerHTML += `<option value="${p.id}" data-nombre="${p.nombre}" data-ci="${p.ci}" data-resultados="${resultadosPaciente}">
                        👤 ${p.nombre} (CI: ${p.ci}) - ${resultadosPaciente} resultado(s)
                    </option>`;
                });
                filterStatusBar.style.display = 'none';
                break;

            case 'prueba':
                filtroLabel.innerHTML = '<i class="fas fa-vial me-1"></i>Seleccionar Prueba:';
                filtroPrincipal.innerHTML = '<option value="">-- Seleccione una prueba --</option>';
                pruebasData.forEach(p => {
                    filtroPrincipal.innerHTML += `<option value="${p.id}" data-nombre="${p.nombre}" data-precio="${p.precio}">
                        🧪 ${p.nombre} - Bs. ${parseFloat(p.precio || 0).toFixed(2)}
                    </option>`;
                });
                filterStatusBar.style.display = 'none';
                break;

            case 'fecha':
                filtroLabel.innerHTML = '<i class="fas fa-calendar-alt me-1"></i>Rango:';
                filtroContainer?.classList.add('d-none');
                fechaDesdeContainer?.classList.remove('d-none');
                fechaHastaContainer?.classList.remove('d-none');

                // Establecer fechas por defecto (último mes)
                const hoy = new Date();
                const hace30Dias = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000);
                document.getElementById('fechaHasta').value = hoy.toISOString().split('T')[0];
                document.getElementById('fechaDesde').value = hace30Dias.toISOString().split('T')[0];

                filterStatusBar.style.display = 'block';
                actualizarVistaPrevia();
                break;
        }

        actualizarVistaPrevia();
    }

    // Actualizar vista previa según selección
    function actualizarVistaPrevia() {
        const tipo = document.getElementById('tipoExportacion')?.value || 'todo';
        const filtroPrincipal = document.getElementById('filtroPrincipal');
        const previewText = document.getElementById('previewText');
        const filterStatusBar = document.getElementById('filterStatusBar');
        const filterStatusText = document.getElementById('filterStatusText');
        const filterPreviewCount = document.getElementById('filterPreviewCount');

        if (tipo === 'todo') {
            previewText.innerHTML = `<strong style="color: #1ABC9C;">📊 Reporte Completo</strong>`;
            return;
        }

        if (tipo === 'paciente' && filtroPrincipal?.value) {
            const selected = filtroPrincipal.selectedOptions[0];
            const nombre = selected?.dataset.nombre || 'Paciente';
            const resultados = selected?.dataset.resultados || 0;

            filterStatusBar.style.display = 'block';
            filterStatusText.textContent = `Paciente: ${nombre}`;
            filterPreviewCount.textContent = `${resultados} resultado(s)`;
            previewText.innerHTML = `<strong style="color: #F39C12;">👤 ${nombre}</strong><br><small>${resultados} resultado(s)</small>`;
            return;
        }

        if (tipo === 'prueba' && filtroPrincipal?.value) {
            const selected = filtroPrincipal.selectedOptions[0];
            const nombre = selected?.dataset.nombre || 'Prueba';
            const precio = selected?.dataset.precio || 0;

            filterStatusBar.style.display = 'block';
            filterStatusText.textContent = `Prueba: ${nombre}`;
            filterPreviewCount.textContent = `Bs. ${parseFloat(precio).toFixed(2)}`;
            previewText.innerHTML = `<strong style="color: #3498DB;">🧪 ${nombre}</strong><br><small>Bs. ${parseFloat(precio).toFixed(2)}</small>`;
            return;
        }

        if (tipo === 'fecha') {
            const desde = document.getElementById('fechaDesde')?.value;
            const hasta = document.getElementById('fechaHasta')?.value;

            if (desde && hasta) {
                // Filtrar resultados por fecha
                const resultadosFiltrados = resultadosData.filter(r => {
                    if (!r.fecha_creacion) return false;
                    const fechaResult = new Date(r.fecha_creacion);
                    return fechaResult >= new Date(desde) && fechaResult <= new Date(hasta + 'T23:59:59');
                });

                filterStatusText.textContent = `Del ${formatearFecha(desde)} al ${formatearFecha(hasta)}`;
                filterPreviewCount.textContent = `${resultadosFiltrados.length} resultado(s)`;
                previewText.innerHTML = `<strong style="color: #9B59B6;">📅 ${resultadosFiltrados.length}</strong><br><small>resultados en rango</small>`;
            }
            return;
        }

        // Sin selección
        previewText.innerHTML = '<span style="color: #6c757d;">Seleccione un filtro</span>';
        filterStatusBar.style.display = 'none';
    }

    function formatearFecha(fechaStr) {
        if (!fechaStr) return '';
        const fecha = new Date(fechaStr + 'T00:00:00');
        return fecha.toLocaleDateString('es-BO', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Limpiar filtros inteligentes
    function limpiarFiltrosInteligentes() {
        document.getElementById('tipoExportacion').value = 'todo';
        document.getElementById('incluirEliminados').checked = false;
        document.getElementById('incluirDetalles').checked = true;
        document.getElementById('fechaDesde').value = '';
        document.getElementById('fechaHasta').value = '';
        actualizarFiltrosInteligentes();
    }

    // Obtener filtros inteligentes
    function obtenerFiltrosInteligentes() {
        const tipo = document.getElementById('tipoExportacion')?.value || 'todo';
        const filtroPrincipal = document.getElementById('filtroPrincipal');
        const selected = filtroPrincipal?.selectedOptions[0];

        return {
            tipo: tipo,
            valor: filtroPrincipal?.value || null,
            nombre: selected?.dataset.nombre || null,
            ci: selected?.dataset.ci || null,
            precio: selected?.dataset.precio || null,
            fechaDesde: document.getElementById('fechaDesde')?.value || null,
            fechaHasta: document.getElementById('fechaHasta')?.value || null,
            incluirEliminados: document.getElementById('incluirEliminados')?.checked || false,
            incluirDetalles: document.getElementById('incluirDetalles')?.checked || true
        };
    }

    // Exportación inteligente
    function ejecutarExportacionInteligente(formato) {
        const filtros = obtenerFiltrosInteligentes();

        // Validar selección
        if (filtros.tipo !== 'todo' && filtros.tipo !== 'fecha' && !filtros.valor) {
            alert('⚠️ Por favor seleccione un elemento específico para exportar.');
            return;
        }

        if (filtros.tipo === 'fecha' && (!filtros.fechaDesde || !filtros.fechaHasta)) {
            alert('⚠️ Por favor seleccione un rango de fechas válido.');
            return;
        }

        // Preparar datos filtrados
        let datosFiltrados = prepararDatosFiltrados(filtros);

        // Ejecutar exportación
        if (formato === 'pdf') {
            exportarPDFInteligente(datosFiltrados, filtros);
        } else {
            exportarExcelInteligente(datosFiltrados, filtros);
        }
    }

    function prepararDatosFiltrados(filtros) {
        let pacientes = [...pacientesData];
        let resultados = [...resultadosData];
        let pruebas = [...pruebasData];

        switch (filtros.tipo) {
            case 'paciente':
                pacientes = pacientes.filter(p => p.id == filtros.valor);
                resultados = resultados.filter(r => r.paciente_id == filtros.valor);
                break;
            case 'prueba':
                pruebas = pruebas.filter(p => p.id == filtros.valor);
                resultados = resultados.filter(r => r.prueba_id == filtros.valor);
                // Filtrar pacientes que tienen resultados con esta prueba
                const pacienteIdsConPrueba = [...new Set(resultados.map(r => r.paciente_id))];
                pacientes = pacientes.filter(p => pacienteIdsConPrueba.includes(p.id));
                break;
            case 'fecha':
                resultados = resultados.filter(r => {
                    if (!r.fecha_creacion) return false;
                    const fecha = new Date(r.fecha_creacion);
                    return fecha >= new Date(filtros.fechaDesde) && fecha <= new Date(filtros.fechaHasta + 'T23:59:59');
                });
                // Filtrar pacientes que tienen resultados en el rango
                const pacienteIds = [...new Set(resultados.map(r => r.paciente_id))];
                pacientes = pacientes.filter(p => pacienteIds.includes(p.id));
                break;
        }

        if (!filtros.incluirEliminados) {
            resultados = resultados.filter(r => !r.eliminado);
        }

        return { pacientes, resultados, pruebas };
    }

    // Funciones de compatibilidad con el sistema anterior
    function obtenerFiltros() {
        return obtenerFiltrosInteligentes();
    }

    function limpiarFiltros() {
        limpiarFiltrosInteligentes();
    }
    // Exportar PDF con filtros inteligentes - VERSIÓN MEJORADA
    async function exportarPDFInteligente(datos, filtros) {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 15;
        let currentY = 50;

        // Header elegante
        pdf.setFillColor(26, 188, 156);
        pdf.rect(0, 0, pageWidth, 45, 'F');

        // Línea decorativa
        pdf.setFillColor(243, 156, 18);
        pdf.rect(0, 45, pageWidth, 3, 'F');

        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(22);
        pdf.setFont(undefined, 'bold');

        // Título dinámico según filtro
        let titulo = 'Laboratorio Pérez';
        let subtitulo = '';
        let fechaGeneracion = new Date().toLocaleDateString('es-BO', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        switch (filtros.tipo) {
            case 'paciente':
                titulo = `Historial de Resultados`;
                subtitulo = `Paciente: ${filtros.nombre} | CI: ${filtros.ci}`;
                break;
            case 'prueba':
                titulo = `Catálogo de Prueba`;
                subtitulo = `${filtros.nombre} - Bs. ${parseFloat(filtros.precio || 0).toFixed(2)}`;
                break;
            case 'fecha':
                titulo = 'Reporte por Período';
                subtitulo = `Del ${formatearFecha(filtros.fechaDesde)} al ${formatearFecha(filtros.fechaHasta)}`;
                break;
            default:
                titulo = 'Reporte General Completo';
                subtitulo = 'Todos los datos del sistema';
        }

        pdf.text(titulo, margin, 20);
        pdf.setFontSize(12);
        pdf.setFont(undefined, 'normal');
        pdf.text(subtitulo, margin, 30);
        pdf.setFontSize(9);
        pdf.text(`Generado: ${fechaGeneracion}`, margin, 38);

        currentY = 58;

        // ===== RESUMEN solo para reporte completo =====
        if (filtros.tipo === 'todo') {
            pdf.setTextColor(44, 62, 80);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('RESUMEN GENERAL', margin, currentY);
            currentY += 8;

            pdf.autoTable({
                startY: currentY,
                head: [['Categoria', 'Cantidad']],
                body: [
                    ['Total Pacientes', datos.pacientes.length],
                    ['Total Resultados', datos.resultados.length],
                    ['Pruebas Disponibles', datos.pruebas.length]
                ],
                theme: 'grid',
                headStyles: { fillColor: [243, 156, 18], textColor: [255, 255, 255], fontStyle: 'bold' },
                styles: { fontSize: 11, cellPadding: 6 },
                columnStyles: { 0: { fontStyle: 'bold' } }
            });
            currentY = pdf.lastAutoTable.finalY + 15;
        }

        // ===== DETALLE DE RESULTADOS mejorado =====
        if (datos.resultados.length > 0) {
            if (currentY > pageHeight - 60) { pdf.addPage(); currentY = 20; }

            pdf.setTextColor(44, 62, 80);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');

            const tituloResultados = filtros.tipo === 'paciente'
                ? `HISTORIAL DE RESULTADOS (${datos.resultados.length})`
                : `DETALLE DE RESULTADOS (${datos.resultados.length})`;
            pdf.text(tituloResultados, margin, currentY);
            currentY += 8;

            // Tabla mejorada con tipo de laboratorio siempre visible
            const resultadosTable = datos.resultados.map(r => [
                r.numero_orden || '-',
                r.paciente_nombre || '-',
                r.tipo_laboratorio || 'General',
                r.fecha_muestra || '-',
                r.codigo_acceso || '-',
                r.eliminado ? 'Eliminado' : 'Activo'
            ]);

            const headerResultados = [['N Orden', 'Paciente', 'Tipo Lab', 'Fecha', 'Codigo', 'Estado']];

            pdf.autoTable({
                startY: currentY,
                head: headerResultados,
                body: resultadosTable,
                theme: 'striped',
                headStyles: { fillColor: [26, 188, 156], textColor: [255, 255, 255], fontStyle: 'bold' },
                styles: { fontSize: 8, cellPadding: 3 },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                columnStyles: {
                    0: { cellWidth: 38 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 22 },
                    4: { cellWidth: 22 },
                    5: { cellWidth: 20 }
                }
            });
        }

        // ===== FOOTER =====
        const totalPages = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            pdf.setPage(i);
            pdf.setFontSize(8);
            pdf.setTextColor(150, 150, 150);
            pdf.text(`Laboratorio Pérez | Página ${i} de ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
        }

        // Descargar
        const fileName = filtros.tipo === 'paciente' ? `historial_${filtros.nombre.replace(/\s/g, '_')}.pdf` :
            filtros.tipo === 'prueba' ? `catalogo_${filtros.nombre.replace(/\s/g, '_')}.pdf` :
                filtros.tipo === 'fecha' ? `reporte_${filtros.fechaDesde}_${filtros.fechaHasta}.pdf` :
                    'reporte_completo_laboratorio.pdf';

        pdf.save(fileName);
        mostrarModalExitoExportacion('PDF', fileName, datos.resultados.length);
    }

    // Exportar Excel con filtros inteligentes - VERSIÓN MEJORADA
    function exportarExcelInteligente(datos, filtros) {
        const wb = XLSX.utils.book_new();

        // Encabezado con info
        let tituloReporte = 'Reporte General';
        if (filtros.tipo === 'paciente') tituloReporte = `Historial de ${filtros.nombre}`;
        if (filtros.tipo === 'prueba') tituloReporte = `Catálogo: ${filtros.nombre}`;
        if (filtros.tipo === 'fecha') tituloReporte = `Reporte ${filtros.fechaDesde} a ${filtros.fechaHasta}`;

        // Hoja de resumen (solo para reporte completo)
        if (filtros.tipo === 'todo') {
            const resumen = [
                ['LABORATORIO PÉREZ - REPORTE COMPLETO'],
                [''],
                ['Generado:', new Date().toLocaleString('es-BO')],
                [''],
                ['RESUMEN ESTADÍSTICO'],
                ['Métrica', 'Valor'],
                ['Total Pacientes', datos.pacientes.length],
                ['Total Resultados', datos.resultados.length],
                ['Total Pruebas', datos.pruebas.length]
            ];
            const wsResumen = XLSX.utils.aoa_to_sheet(resumen);
            XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');
        }

        // Hoja de resultados (siempre incluir)
        if (datos.resultados.length > 0) {
            const resultadosSheet = datos.resultados.map(r => ({
                'N° Orden': r.numero_orden,
                'Paciente': r.paciente_nombre,
                'CI': r.paciente_ci,
                'Tipo Laboratorio': r.tipo_laboratorio || 'General',
                'Fecha Muestra': r.fecha_muestra || '-',
                'Código Acceso': r.codigo_acceso || '-',
                'Fecha Creación': r.fecha_creacion || '-',
                'Estado': r.eliminado ? 'Eliminado' : 'Activo'
            }));
            const wsResultados = XLSX.utils.json_to_sheet(resultadosSheet);
            XLSX.utils.book_append_sheet(wb, wsResultados, 'Resultados');
        }

        // Hoja de pacientes (solo si hay y si es reporte completo)
        if (datos.pacientes.length > 0 && (filtros.tipo === 'todo' || filtros.tipo === 'fecha')) {
            const pacientesSheet = datos.pacientes.map(p => ({
                'ID': p.id,
                'Nombre Completo': p.nombre,
                'Cédula de Identidad': p.ci,
                'Teléfono': p.telefono || '-',
                'Correo Electrónico': p.email || '-',
                'Fecha Registro': p.fecha_registro || '-'
            }));
            const wsPacientes = XLSX.utils.json_to_sheet(pacientesSheet);
            XLSX.utils.book_append_sheet(wb, wsPacientes, 'Pacientes');
        }

        // Hoja de pruebas
        if (datos.pruebas.length > 0 && filtros.tipo === 'todo') {
            const pruebasSheet = datos.pruebas.map(p => ({
                'ID': p.id,
                'Nombre de Prueba': p.nombre,
                'Precio (Bs)': parseFloat(p.precio || 0).toFixed(2),
                'Descripción': p.descripcion || '-'
            }));
            const wsPruebas = XLSX.utils.json_to_sheet(pruebasSheet);
            XLSX.utils.book_append_sheet(wb, wsPruebas, 'Catálogo Pruebas');
        }

        // Descargar
        const fileName = filtros.tipo === 'paciente' ? `historial_${filtros.nombre.replace(/\s/g, '_')}.xlsx` :
            filtros.tipo === 'prueba' ? `catalogo_${filtros.nombre.replace(/\s/g, '_')}.xlsx` :
                filtros.tipo === 'fecha' ? `reporte_${filtros.fechaDesde}_${filtros.fechaHasta}.xlsx` :
                    'reporte_completo_laboratorio.xlsx';

        XLSX.writeFile(wb, fileName);
        mostrarModalExitoExportacion('Excel', fileName, datos.resultados.length);
    }

    // Modal de éxito elegante
    function mostrarModalExitoExportacion(tipo, archivo, cantidadResultados) {
        // Remover modal anterior si existe
        document.querySelectorAll('.export-success-modal').forEach(el => el.remove());

        const icono = tipo === 'PDF' ? 'fa-file-pdf' : 'fa-file-excel';
        const color = tipo === 'PDF' ? '#E74C3C' : '#27AE60';

        const modal = document.createElement('div');
        modal.className = 'export-success-modal';
        modal.innerHTML = `
            <style>
                .export-success-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                    animation: fadeIn 0.3s ease;
                }
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                .export-success-box {
                    background: white;
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 450px;
                    box-shadow: 0 25px 80px rgba(0,0,0,0.3);
                    animation: slideUp 0.4s ease;
                }
                @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                .export-success-icon {
                    width: 80px;
                    height: 80px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 20px;
                    animation: pulse 1s ease infinite;
                }
                @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
                .export-success-icon i { font-size: 40px; color: white; }
                .export-success-title { font-size: 1.8rem; font-weight: 800; color: #2C3E50; margin-bottom: 10px; }
                .export-success-subtitle { font-size: 1rem; color: #7F8C8D; margin-bottom: 25px; }
                .export-success-file { 
                    background: #f8f9fa; 
                    padding: 12px 20px; 
                    border-radius: 10px; 
                    font-family: monospace; 
                    font-size: 0.9rem;
                    color: #2C3E50;
                    margin-bottom: 25px;
                    word-break: break-all;
                }
                .export-success-stats {
                    display: flex;
                    justify-content: center;
                    gap: 30px;
                    margin-bottom: 25px;
                }
                .export-stat {
                    text-align: center;
                }
                .export-stat-value { font-size: 2rem; font-weight: 800; color: ${color}; }
                .export-stat-label { font-size: 0.8rem; color: #7F8C8D; text-transform: uppercase; }
                .export-success-btn {
                    background: linear-gradient(135deg, ${color}, ${tipo === 'PDF' ? '#C0392B' : '#229954'});
                    color: white;
                    border: none;
                    padding: 14px 40px;
                    border-radius: 50px;
                    font-size: 1rem;
                    font-weight: 700;
                    cursor: pointer;
                    transition: all 0.3s;
                    box-shadow: 0 8px 25px ${color}40;
                }
                .export-success-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 35px ${color}50; }
            </style>
            <div class="export-success-box">
                <div class="export-success-icon" style="background: linear-gradient(135deg, ${color}, ${tipo === 'PDF' ? '#C0392B' : '#229954'});">
                    <i class="fas ${icono}"></i>
                </div>
                <div class="export-success-title">¡Exportación Exitosa!</div>
                <div class="export-success-subtitle">Tu archivo ${tipo} ha sido generado correctamente</div>
                <div class="export-success-file">
                    <i class="fas fa-download" style="color: ${color}; margin-right: 8px;"></i>
                    ${archivo}
                </div>
                <div class="export-success-stats">
                    <div class="export-stat">
                        <div class="export-stat-value">${cantidadResultados}</div>
                        <div class="export-stat-label">Resultados</div>
                    </div>
                    <div class="export-stat">
                        <div class="export-stat-value"><i class="fas fa-check-circle"></i></div>
                        <div class="export-stat-label">Completo</div>
                    </div>
                </div>
                <button class="export-success-btn" onclick="this.closest('.export-success-modal').remove()">
                    <i class="fas fa-check me-2"></i>Perfecto
                </button>
            </div>
        `;

        document.body.appendChild(modal);

        // Cerrar al hacer clic fuera
        modal.addEventListener('click', function (e) {
            if (e.target === modal) modal.remove();
        });
    }
    function ejecutarExportacionFiltrada(tipo, btnElement) {
        const filtros = obtenerFiltros();
        const selecciones = [];

        // Determinar qué exportar basado en filtros activos
        if (filtros.pacienteId) {
            selecciones.push('pacientes');
        } else if (filtros.pruebaId) {
            selecciones.push('pruebas');
        } else if (filtros.resultadosPacienteId) {
            selecciones.push('resultados');
        } else {
            alert('Por favor seleccione un paciente, prueba o resultado específico en los filtros para usar esta opción.');
            return;
        }

        // Guardar contexto
        window.exportSelecciones = selecciones;
        window.exportFiltros = filtros;
        if (btnElement) window.currentExportBtn = btnElement;

        if (tipo === 'pdf') {
            exportarPDF(selecciones, filtros);
        } else if (tipo === 'excel') {
            exportarExcel(selecciones, filtros);
        }
    }

    // Función principal de exportación llamada por los botones generales
    function ejecutarExportacion(tipo) {
        const selecciones = obtenerSelecciones();
        if (!selecciones.length) {
            alert('Por favor seleccione al menos una opción para exportar');
            return;
        }

        // Obtener filtros (aunque sean generales)
        const filtros = obtenerFiltros();

        window.exportSelecciones = selecciones;
        window.exportFiltros = filtros;

        if (tipo === 'pdf') {
            window.currentExportBtn = document.getElementById('btnExportPDF');
            exportarPDF(selecciones, filtros);
        } else if (tipo === 'excel') {
            window.currentExportBtn = document.getElementById('btnExportExcel');
            exportarExcel(selecciones, filtros);
        }
    }

    // Función para exportar a PDF (VERSION MEJORADA CON AUTOTABLE)
    async function exportarPDF(selecciones, filtros) {
        selecciones = selecciones || window.exportSelecciones || [];
        filtros = filtros || window.exportFiltros || {};
        const { jsPDF } = window.jspdf;

        // Indicador de carga
        const btnPDF = window.currentExportBtn || document.getElementById('btnExportPDF');
        const originalHTML = btnPDF?.innerHTML || '';
        if (btnPDF) {
            btnPDF.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando PDF...';
            btnPDF.disabled = true;
        }

        try {
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            let currentY = 50; // Posición inicial después del header

            // Obtener datos
            const exportDataEl = document.getElementById('export-data');
            let exportData = exportDataEl ? JSON.parse(exportDataEl.textContent) : {};
            const pdfStats = exportData.estadisticas || {};

            // Aplicar filtros
            let pacientesFiltrados = exportData.pacientes || [];
            let pruebasFiltradas = exportData.pruebas || [];
            let resultadosFiltrados = exportData.resultados || [];

            if (filtros.pacienteId) {
                pacientesFiltrados = pacientesFiltrados.filter(p => p.id == filtros.pacienteId);
            }
            if (filtros.pruebaId) {
                pruebasFiltradas = pruebasFiltradas.filter(p => p.id == filtros.pruebaId);
            }
            if (filtros.resultadosPacienteId) {
                resultadosFiltrados = resultadosFiltrados.filter(r => r.paciente_id == filtros.resultadosPacienteId);
            }

            // --- HEADER GENERICO ---
            pdf.setFillColor(26, 188, 156);
            pdf.rect(0, 0, pageWidth, 40, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(22);
            pdf.setFont(undefined, 'bold');

            // Título Dinámico
            let titulo = 'Laboratorio Pérez - Reporte General';
            if (selecciones.length === 1 && selecciones.includes('pacientes') && filtros.pacienteNombre) {
                titulo = 'Reporte de Paciente: ' + filtros.pacienteNombre;
            } else if (selecciones.length === 1 && selecciones.includes('pruebas') && filtros.pruebaNombre) {
                titulo = 'Reporte de Prueba: ' + filtros.pruebaNombre;
            }
            pdf.text(titulo, margin, 20);

            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            const fecha = new Date().toLocaleDateString('es-BO', { year: 'numeric', month: 'long', day: 'numeric' });
            pdf.text(`Potosí, Bolivia - ${fecha}`, margin, 30);

            if (filtros.incluirEliminados) {
                pdf.setFontSize(9);
                pdf.text('* Incluye registros eliminados', pageWidth - margin - 50, 30);
            }

            // --- SECCIONES ---

            // 1. ESTADÍSTICAS
            if (selecciones.includes('estadisticas')) {
                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('ESTADÍSTICAS GENERALES', margin, currentY);
                currentY += 10;

                const statsData = [
                    ['Total Pacientes', pdfStats.totalPacientes || 0],
                    ['Total Resultados', pdfStats.totalResultados || 0],
                    ['Pruebas Disponibles', pdfStats.totalPruebas || 0]
                ];

                pdf.autoTable({
                    startY: currentY,
                    head: [['Métrica', 'Valor']],
                    body: statsData,
                    theme: 'striped',
                    headStyles: { fillColor: [44, 62, 80] },
                    styles: { fontSize: 10 },
                    columnStyles: { 0: { fontStyle: 'bold', width: 100 } }
                });

                currentY = pdf.lastAutoTable.finalY + 15;

                // Gráfico (si existe el canvas)
                const trendCanvas = document.getElementById('trendChart');
                if (trendCanvas) {
                    if (currentY > pageHeight - 80) { pdf.addPage(); currentY = margin; }

                    pdf.setFontSize(14);
                    pdf.text('Tendencia Mensual', margin, currentY);
                    currentY += 5;

                    const trendImage = trendCanvas.toDataURL('image/png');
                    const imgHeight = 70;
                    const imgWidth = (trendCanvas.width * imgHeight) / trendCanvas.height;
                    pdf.addImage(trendImage, 'PNG', margin, currentY, imgWidth < pageWidth - 30 ? imgWidth : pageWidth - 30, imgHeight);
                    currentY += imgHeight + 15;
                }
            }

            // 2. PACIENTES
            if (selecciones.includes('pacientes')) {
                if (currentY > pageHeight - 40) { pdf.addPage(); currentY = margin; }

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('LISTADO DE PACIENTES', margin, currentY);
                currentY += 8;

                const bodyPacientes = pacientesFiltrados.map(p => [p.nombre, p.ci, p.email || '-', p.telefono || '-']);

                pdf.autoTable({
                    startY: currentY,
                    head: [['Nombre Completo', 'CI', 'Email', 'Teléfono']],
                    body: bodyPacientes,
                    theme: 'striped',
                    headStyles: { fillColor: [243, 156, 18] }, // Orange theme
                    styles: { fontSize: 9 },
                    alternateRowStyles: { fillColor: [253, 242, 233] },
                });
                currentY = pdf.lastAutoTable.finalY + 15;
            }

            // 3. PRUEBAS
            if (selecciones.includes('pruebas')) {
                if (currentY > pageHeight - 40) { pdf.addPage(); currentY = margin; }

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('CATÁLOGO DE PRUEBAS', margin, currentY);
                currentY += 8;

                const bodyPruebas = pruebasFiltradas.map(p => [p.nombre, p.categoria, `Bs. ${p.precio}`, p.descripcion]);

                pdf.autoTable({
                    startY: currentY,
                    head: [['Nombre de Prueba', 'Categoría', 'Precio', 'Descripción']],
                    body: bodyPruebas,
                    theme: 'striped',
                    headStyles: { fillColor: [52, 152, 219] }, // Blue theme
                    styles: { fontSize: 9 },
                    columnStyles: { 3: { cellWidth: 80 } } // Wider description
                });
                currentY = pdf.lastAutoTable.finalY + 15;
            }

            // 4. RESULTADOS (Con Tipo de Laboratorio)
            if (selecciones.includes('resultados')) {
                if (currentY > pageHeight - 40) { pdf.addPage(); currentY = margin; }

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('HISTORIAL DE RESULTADOS', margin, currentY);
                currentY += 8;

                const bodyResultados = resultadosFiltrados.map(r => [
                    r.numero_orden,
                    r.paciente_nombre,
                    r.paciente_ci,
                    r.tipo_laboratorio || 'General', // Nuevo campo
                    r.fecha_muestra,
                    r.codigo_acceso
                ]);

                pdf.autoTable({
                    startY: currentY,
                    head: [['Nº Orden', 'Paciente', 'CI', 'Tipo Laboratorio', 'Fecha', 'Código']],
                    body: bodyResultados,
                    theme: 'striped',
                    headStyles: { fillColor: [231, 76, 60] }, // Red theme
                    styles: { fontSize: 9 },
                    alternateRowStyles: { fillColor: [253, 237, 236] },
                });
                currentY = pdf.lastAutoTable.finalY + 15;
            }

            pdf.save(`Reporte_Laboratorio_${new Date().toISOString().slice(0, 10)}.pdf`);

        } catch (error) {
            console.error(error);
            alert('Error al generar PDF: ' + error.message);
        } finally {
            if (btnPDF) {
                btnPDF.innerHTML = originalHTML;
                btnPDF.disabled = false;
            }
        }
    }

    // Función para exportar a Excel (Completa con filtros)
    function exportarExcel(selecciones, filtros) {
        selecciones = selecciones || window.exportSelecciones || [];
        filtros = filtros || window.exportFiltros || {};

        const btnExcel = window.currentExportBtn || document.getElementById('btnExportExcel');
        const originalHTML = btnExcel?.innerHTML || '';
        if (btnExcel) {
            btnExcel.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando Excel...';
            btnExcel.disabled = true;
        }

        try {
            const wb = XLSX.utils.book_new();
            const exportDataEl = document.getElementById('export-data');
            let exportData = exportDataEl ? JSON.parse(exportDataEl.textContent) : {};

            // Aplicar filtros
            let pacientesFiltrados = exportData.pacientes || [];
            let pruebasFiltradas = exportData.pruebas || [];
            let resultadosFiltrados = exportData.resultados || [];

            if (filtros.pacienteId) {
                pacientesFiltrados = pacientesFiltrados.filter(p => p.id == filtros.pacienteId);
            }
            if (filtros.pruebaId) {
                pruebasFiltradas = pruebasFiltradas.filter(p => p.id == filtros.pruebaId);
            }
            if (filtros.resultadosPacienteId) {
                resultadosFiltrados = resultadosFiltrados.filter(r => r.paciente_id == filtros.resultadosPacienteId);
            }

            // HOJA PACIENTES
            if (selecciones.includes('pacientes')) {
                const wsData = [['ID', 'Nombre', 'CI', 'Teléfono', 'Email', 'Fecha Registro']];
                pacientesFiltrados.forEach(p => {
                    wsData.push([p.id, p.nombre, p.ci, p.telefono, p.email, p.fecha_registro]);
                });
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Pacientes");
            }

            // HOJA PRUEBAS
            if (selecciones.includes('pruebas')) {
                const wsData = [['ID', 'Nombre', 'Categoría', 'Precio', 'Descripción']];
                pruebasFiltradas.forEach(pr => {
                    wsData.push([pr.id, pr.nombre, pr.categoria, pr.precio, pr.descripcion]);
                });
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Pruebas");
            }

            // HOJA RESULTADOS
            if (selecciones.includes('resultados')) {
                const wsData = [['ID', 'Orden', 'Paciente', 'CI', 'Fecha', 'Código Acceso']];
                resultadosFiltrados.forEach(r => {
                    wsData.push([r.id, r.numero_orden, r.paciente_nombre, r.paciente_ci, r.fecha_muestra, r.codigo_acceso]);
                });
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Resultados");
            }

            // HOJA ESTADÍSTICAS (si seleccionada, simplificada)
            if (selecciones.includes('estadisticas')) {
                const stats = exportData.estadisticas || {};
                const wsData = [
                    ['Métrica', 'Valor'],
                    ['Total Pacientes', stats.totalPacientes],
                    ['Total Resultados', stats.totalResultados],
                    ['Total Pruebas', stats.totalPruebas]
                ];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Estadisticas");
            }

            XLSX.writeFile(wb, `Export_Laboratorio_${new Date().toISOString().slice(0, 10)}.xlsx`);

        } catch (error) {
            console.error(error);
            alert('Error al generar Excel');
        } finally {
            if (btnExcel) {
                btnExcel.innerHTML = originalHTML;
                btnExcel.disabled = false;
            }
        }
    }

    function obtenerSelecciones() {
        const selecciones = [];
        if (document.getElementById('exportPacientes')?.checked) selecciones.push('pacientes');
        if (document.getElementById('exportResultados')?.checked) selecciones.push('resultados');
        if (document.getElementById('exportPruebas')?.checked) selecciones.push('pruebas');
        if (document.getElementById('exportEstadisticas')?.checked) selecciones.push('estadisticas');
        return selecciones;
    }

    // Hover effects para filter options
    document.querySelectorAll('.export-option').forEach(option => {
        const checkbox = option.querySelector('input[type="checkbox"]');
        function updateStyle() {
            if (checkbox?.checked) {
                option.style.borderColor = '#F39C12';
                option.style.background = 'rgba(243, 156, 18, 0.1)';
            } else {
                option.style.borderColor = 'transparent';
                option.style.background = '#f8f9fa';
            }
        }
        checkbox?.addEventListener('change', updateStyle);
        updateStyle();
    });
</script>
{% endblock %}